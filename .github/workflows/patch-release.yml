# Patch Release workflow - manually re-uploads build artifact to an existing release
# Use this to ship hotfixes without bumping the version number.
# The app's updater detects patches by comparing GitHub asset IDs.

name: Patch Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Existing release tag to patch (e.g. v0.4.3)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  patch:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Get version from tag
        id: get_version
        shell: bash
        run: |
          TAG="${{ github.event.inputs.tag }}"
          echo "VERSION=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Update package.json version
        shell: pwsh
        run: |
          $pkg = Get-Content package.json | ConvertFrom-Json
          $pkg.version = "${{ steps.get_version.outputs.VERSION }}"
          $pkg | ConvertTo-Json -Depth 100 | Set-Content package.json

      - name: Build with electron-builder
        run: npm run dist:dir
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create portable zip
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $zipName = "OddsMoni-$version-win64-portable.zip"
          Compress-Archive -Force -Path "dist/win-unpacked/*" -DestinationPath "dist/$zipName"
          echo "ZIP_NAME=$zipName" >> $env:GITHUB_ENV
          echo "ZIP_PATH=dist/$zipName" >> $env:GITHUB_ENV

      - name: Delete old asset and upload new one
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const tag = '${{ github.event.inputs.tag }}';
            const zipName = process.env.ZIP_NAME;
            const zipPath = process.env.ZIP_PATH;
            const fs = require('fs');

            // Find release by tag
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner, repo, tag
            });
            console.log(`Found release: ${release.name} (id: ${release.id})`);

            // Delete old zip assets with matching name
            for (const asset of release.assets) {
              if (asset.name === zipName) {
                console.log(`Deleting old asset: ${asset.name} (id: ${asset.id})`);
                await github.rest.repos.deleteReleaseAsset({ owner, repo, asset_id: asset.id });
              }
            }

            // Upload new asset
            console.log(`Uploading new asset: ${zipName}`);
            const data = fs.readFileSync(zipPath);
            await github.rest.repos.uploadReleaseAsset({
              owner, repo,
              release_id: release.id,
              name: zipName,
              data,
              headers: { 'content-type': 'application/zip', 'content-length': data.length }
            });

            console.log('Patch uploaded successfully! New asset ID will be detected by updater.');

      - name: Update release body with patch note
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const tag = '${{ github.event.inputs.tag }}';
            const sha = '${{ github.sha }}'.substring(0, 7);

            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner, repo, tag
            });

            const patchNote = `\n\n---\n_Patched: ${new Date().toISOString().split('T')[0]} (${sha})_`;

            // Append patch note only if not already present
            if (!release.body.includes('_Patched:')) {
              await github.rest.repos.updateRelease({
                owner, repo,
                release_id: release.id,
                body: release.body + patchNote
              });
              console.log('Added patch note to release body');
            } else {
              // Replace existing patch note
              const updated = release.body.replace(/_Patched:.*_/, `_Patched: ${new Date().toISOString().split('T')[0]} (${sha})_`);
              await github.rest.repos.updateRelease({
                owner, repo,
                release_id: release.id,
                body: updated
              });
              console.log('Updated existing patch note');
            }
