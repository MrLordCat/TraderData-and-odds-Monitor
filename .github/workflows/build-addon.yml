# Build Addon Package
# 
# Triggered when pushing changes to addons-dev/ folder
# Packages each addon as a zip and uploads to releases

name: Build Addon

on:
  push:
    branches:
      - main
    paths:
      - 'addons-dev/**'
    tags:
      - 'addon-*'
  workflow_dispatch:
    inputs:
      addon_id:
        description: 'Addon ID to build (folder name in addons-dev/)'
        required: true
        default: 'power-towers'

jobs:
  build-addon:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Find addons to build
        id: find-addons
        run: |
          # If manual trigger, use input
          if [ -n "${{ github.event.inputs.addon_id }}" ]; then
            echo "addons=${{ github.event.inputs.addon_id }}" >> $GITHUB_OUTPUT
          else
            # Find all addon directories with manifest.json
            ADDONS=""
            for dir in addons-dev/*/; do
              if [ -f "${dir}manifest.json" ]; then
                ADDON_NAME=$(basename "$dir")
                ADDONS="${ADDONS}${ADDON_NAME} "
              fi
            done
            echo "addons=$ADDONS" >> $GITHUB_OUTPUT
          fi
          
      - name: Build addons
        id: build
        run: |
          mkdir -p dist
          
          for ADDON_ID in ${{ steps.find-addons.outputs.addons }}; do
            ADDON_DIR="addons-dev/${ADDON_ID}"
            
            if [ ! -f "${ADDON_DIR}/manifest.json" ]; then
              echo "Skipping ${ADDON_ID}: no manifest.json"
              continue
            fi
            
            # Read manifest
            ADDON_VERSION=$(jq -r '.version' "${ADDON_DIR}/manifest.json")
            ADDON_NAME=$(jq -r '.name' "${ADDON_DIR}/manifest.json")
            ZIP_NAME="${ADDON_ID}-v${ADDON_VERSION}.zip"
            
            echo "Building ${ADDON_NAME} v${ADDON_VERSION}..."
            
            # Create zip
            cd "${ADDON_DIR}"
            zip -r "../../dist/${ZIP_NAME}" . \
              -x "*.git*" \
              -x "node_modules/*" \
              -x "*.md" \
              -x ".DS_Store"
            cd ../..
            
            echo "Created dist/${ZIP_NAME}"
            
            # Save info for release
            echo "addon_id=${ADDON_ID}" >> $GITHUB_OUTPUT
            echo "addon_version=${ADDON_VERSION}" >> $GITHUB_OUTPUT
            echo "addon_name=${ADDON_NAME}" >> $GITHUB_OUTPUT
            echo "zip_name=${ZIP_NAME}" >> $GITHUB_OUTPUT
          done
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: addons
          path: dist/*.zip
          
      - name: Create/Update Release
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/addon-')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: addon-${{ steps.build.outputs.addon_id }}-v${{ steps.build.outputs.addon_version }}
          name: "${{ steps.build.outputs.addon_name }} v${{ steps.build.outputs.addon_version }}"
          body: |
            ## ${{ steps.build.outputs.addon_name }}
            
            Version: ${{ steps.build.outputs.addon_version }}
            
            ### Installation
            1. Open app Settings â†’ Addons
            2. Click "Refresh" to see available addons
            3. Click "Install" next to this addon
            4. Restart the app
          files: dist/${{ steps.build.outputs.zip_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
