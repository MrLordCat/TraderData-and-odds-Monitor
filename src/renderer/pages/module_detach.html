<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>Module</title>
  <link rel="stylesheet" href="../styles/m3-tokens.css" />
  <link rel="stylesheet" href="../styles/common.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: var(--md-sys-color-surface);
      color: var(--md-sys-color-on-surface);
    }
    
    #moduleContainer {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    #moduleHeader {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--md-sys-color-surface-container);
      border-bottom: 1px solid var(--md-sys-color-outline-variant);
      flex-shrink: 0;
      -webkit-app-region: drag;
    }
    
    #moduleTitle {
      font-weight: 500;
      font-size: 14px;
      flex: 1;
    }
    
    #attachBtn {
      -webkit-app-region: no-drag;
      padding: 4px 12px;
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: 4px;
      background: var(--md-sys-color-surface-container-high);
      color: var(--md-sys-color-on-surface);
      cursor: pointer;
      font-size: 12px;
    }
    
    #attachBtn:hover {
      background: var(--md-sys-color-surface-container-highest);
    }
    
    #moduleBody {
      flex: 1;
      overflow: hidden;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--md-sys-color-on-surface-variant);
    }
    
    .error {
      padding: 20px;
      color: var(--md-sys-color-error);
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="moduleContainer">
    <div id="moduleHeader">
      <span id="moduleTitle">Module</span>
      <button id="attachBtn" title="Reattach to sidebar">â¬… Attach</button>
    </div>
    <div id="moduleBody">
      <div class="loading">Loading module...</div>
    </div>
  </div>
  
  <script>
    (function() {
      const { ipcRenderer } = require('electron');
      const fs = require('fs');
      const path = require('path');
      
      console.log('[detach] Script started');
      
      // Parse query params
      const params = new URLSearchParams(window.location.search);
      const moduleId = params.get('moduleId');
      const modulePath = decodeURIComponent(params.get('modulePath') || '');
      const title = params.get('title') || 'Module';
      
      console.log(`[detach] Params: moduleId=${moduleId}, title=${title}, modulePath=${modulePath}`);
      
      // Update title
      document.title = title;
      document.getElementById('moduleTitle').textContent = title;
      
      // Attach button - needs to save state before closing
      document.getElementById('attachBtn').addEventListener('click', async () => {
        // Try to save state if module supports it
        if (window._currentModuleInstance && typeof window._currentModuleInstance.getSerializedState === 'function') {
          const state = window._currentModuleInstance.getSerializedState();
          if (state) {
            await ipcRenderer.invoke('module-store-state', { moduleId, state });
            console.log('[detach] State saved before attach');
          }
        }
        ipcRenderer.invoke('module-attach', { moduleId });
      });
      
      // Load module
      async function loadModule() {
        const body = document.getElementById('moduleBody');
        
        if (!modulePath || !fs.existsSync(modulePath)) {
          body.innerHTML = '<div class="error">Module file not found</div>';
          return;
        }
        
        try {
          // Get stored state from main process
          const stateResult = await ipcRenderer.invoke('module-get-state', { moduleId });
          const savedState = stateResult.success ? stateResult.state : null;
          console.log('[detach] Retrieved saved state:', !!savedState);
          
          // Clear the stored state after retrieval (consumed)
          if (savedState) {
            await ipcRenderer.invoke('module-clear-state', { moduleId });
          }
          
          // Simple SidebarModule base for detached mode
          class SidebarModule {
            static id = 'base';
            static title = 'Module';
            static order = 100;
            
            constructor(options = {}) {
              this.options = options;
              this.container = null;
              this.isDetached = true;
              this._savedState = options.savedState || null;
            }
            
            getTemplate() { return '<div>Module content</div>'; }
            getStyles() { return ''; }
            
            onMount(container) {
              this.container = container;
            }
            
            onUnmount() {
              this.container = null;
            }
            
            // Override in subclass to provide serialized state
            getSerializedState() {
              return null;
            }
          }
          
          // Clear cache and load
          delete require.cache[require.resolve(modulePath)];
          const exported = require(modulePath);
          
          let ModuleClass;
          if (typeof exported === 'function' && !exported.id) {
            ModuleClass = exported({ SidebarModule, registerModule: () => {} });
          } else {
            ModuleClass = exported;
          }
          
          if (!ModuleClass || !ModuleClass.id) {
            body.innerHTML = '<div class="error">Invalid module</div>';
            return;
          }
          
          // Create instance with detached flag AND saved state
          const instance = new ModuleClass({ 
            isDetached: true,
            savedState: savedState
          });
          
          // Store reference for state saving
          window._currentModuleInstance = instance;
          
          // Render
          body.innerHTML = instance.getTemplate();
          
          // Add styles
          const styles = instance.getStyles();
          if (styles) {
            const styleEl = document.createElement('style');
            styleEl.textContent = styles;
            document.head.appendChild(styleEl);
          }
          
          // Mount
          instance.onMount(body);
          
          console.log(`[detach] Module loaded: ${ModuleClass.id}, withState: ${!!savedState}`);
          
        } catch (e) {
          console.error('[detach] Failed to load module:', e);
          body.innerHTML = `<div class="error">Failed to load module: ${e.message}</div>`;
        }
      }
      
      loadModule();
    })();
  </script>
</body>
</html>
